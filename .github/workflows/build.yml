name: Test and Coverage
on:
  push:
    branches:
      - main
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm run test:coverage

      - uses: qltysh/qlty-action/coverage@v2
        with:
          token: ${{ secrets.QLTY_COVERAGE_TOKEN }}
          files: coverage/lcov.info

      - name: Upload coverage manually
        run: |
          LCOV_BASE64=$(base64 -w 0 coverage/lcov.info)

          curl -X POST https://6aeef2453f19.ngrok-free.app/api/coverage/upload \
            -H "Content-Type: application/json" \
            -d "{
              \"coverage\": \"${LCOV_BASE64}\",
              \"commit\": \"${{ github.sha }}\",
              \"branch\": \"${{ github.ref_name }}\",
              \"ref\": \"${{ github.ref }}\",
              \"repository\": \"${{ github.repository }}\",
              \"token\": \"${{ secrets.BOB_COVERAGE_TOKEN }}\",
              \"buildId\": \"${{ github.run_id }}:${{ github.run_attempt }}\"
            }"
